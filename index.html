<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>My Plant Catalogue</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Merriweather', serif;
    }

    /* Optional subtle leaf pattern */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('https://www.transparenttextures.com/patterns/leaf.png') repeat;
      opacity: 0.05;
      pointer-events: none;
      z-index: -1;
    }
  </style>
</head>

<body class="bg-green-50">

  <!-- Header -->
  <header class="text-center py-6 bg-green-700 text-white shadow-lg">
    <h1 class="text-4xl font-bold">üåø My Plant Catalogue üåø</h1>
  </header>

  <!-- Description Section -->
  <section class="max-w-3xl mx-auto text-center bg-green-100 rounded-xl p-4 mt-6 shadow-inner">
    <p class="text-green-800 text-lg">
      Welcome to my home plant catalogue! üå± These plants are all from my home garden.
      Identification has been assisted by AI, so there may be some inaccuracies.
      Enjoy exploring the greenery! üçÉ
    </p>
  </section>

  <main class="p-6 max-w-7xl mx-auto">

    <!-- Controls Section: Search, Filter, Sort -->
    <div class="mb-8 bg-white p-6 rounded-2xl shadow-sm border border-green-100">

      <!-- Top Row: Search & Sort -->
      <div class="flex flex-col md:flex-row gap-4 mb-4 justify-between items-center">
        <!-- Search -->
        <div class="w-full md:w-1/2">
          <input id="searchInput" type="text" placeholder="Search plants by name..."
            class="w-full rounded-full px-4 py-2 border border-green-300 focus:outline-none focus:ring-2 focus:ring-green-400">
        </div>

        <!-- Sort -->
        <div class="flex items-center gap-2 w-full md:w-auto">
          <label for="sortSelect" class="text-green-800 font-semibold whitespace-nowrap">Sort by:</label>
          <select id="sortSelect"
            class="w-full md:w-auto rounded-lg px-3 py-2 border border-green-300 text-green-800 bg-white focus:outline-none focus:ring-2 focus:ring-green-400">
            <option value="name_asc">Name (A-Z)</option>
            <option value="name_desc">Name (Z-A)</option>
            <option value="date_desc">Newest First</option>
            <option value="date_asc">Oldest First</option>
            <option value="conf_desc">Confidence (High-Low)</option>
            <option value="conf_asc">Confidence (Low-High)</option>
          </select>
        </div>
      </div>

      <!-- Bottom Row: Filters -->
      <div class="flex flex-col md:flex-row gap-6 items-start md:items-center">

        <!-- Attribute Filters -->
        <div class="flex flex-wrap gap-4">
          <span class="text-green-800 font-semibold">Attributes:</span>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" class="filter-attr w-4 h-4 text-green-600 rounded focus:ring-green-500"
              value="is_flowering">
            <span class="text-green-700">Flowering</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" class="filter-attr w-4 h-4 text-green-600 rounded focus:ring-green-500"
              value="is_medicinal">
            <span class="text-green-700">Medicinal</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" class="filter-attr w-4 h-4 text-green-600 rounded focus:ring-green-500"
              value="is_edible">
            <span class="text-green-700">Edible</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" class="filter-attr w-4 h-4 text-green-600 rounded focus:ring-green-500"
              value="is_toxic_to_pets">
            <span class="text-red-600">Toxic to Pets</span>
          </label>
        </div>

        <!-- Confidence Filter -->
        <div class="flex items-center gap-2">
          <label for="confFilter" class="text-green-800 font-semibold whitespace-nowrap">Min Confidence:</label>
          <select id="confFilter"
            class="rounded-lg px-2 py-1 border border-green-300 text-green-800 bg-white focus:outline-none focus:ring-2 focus:ring-green-400">
            <option value="0">All</option>
            <option value="0.9">90%+</option>
            <option value="0.8">80%+</option>
            <option value="0.5">50%+</option>
          </select>
        </div>

      </div>
    </div>

    <!-- Plant Grid -->
    <div id="plantGrid" class="grid gap-6 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
  </main>

  <script>
    async function loadPlants() {
      const plantGrid = document.getElementById('plantGrid');
      const searchInput = document.getElementById('searchInput');
      const sortSelect = document.getElementById('sortSelect');
      const confFilter = document.getElementById('confFilter');
      const attrCheckboxes = document.querySelectorAll('.filter-attr');

      let plants = [];

      try {
        const indexRes = await fetch('data/index.json');
        const jsonFiles = await indexRes.json();

        for (const filename of jsonFiles) {
          try {
            const res = await fetch(`data/${filename}`);
            const plant = await res.json();
            plants.push(plant);
          } catch (e) {
            console.error(`Failed to load data/${filename}:`, e);
          }
        }

        function getFilteredAndSortedPlants() {
          let result = [...plants];

          // 1. Search (Name or Local Name)
          const query = searchInput.value.toLowerCase();
          if (query) {
            result = result.filter(p =>
              p.identified_name.toLowerCase().includes(query) ||
              (p.local_names && p.local_names.some(l => l.name.toLowerCase().includes(query)))
            );
          }

          // 2. Attributes (AND logic: must match all checked)
          attrCheckboxes.forEach(cb => {
            if (cb.checked) {
              const key = cb.value;
              result = result.filter(p => p[key] === true);
            }
          });

          // 3. Confidence
          const minConf = parseFloat(confFilter.value);
          if (minConf > 0) {
            result = result.filter(p => (p.confidence || 0) >= minConf);
          }

          // 4. Sort
          const sortMode = sortSelect.value;
          result.sort((a, b) => {
            switch (sortMode) {
              case 'name_asc':
                return a.identified_name.localeCompare(b.identified_name);
              case 'name_desc':
                return b.identified_name.localeCompare(a.identified_name);
              case 'conf_desc':
                return (b.confidence || 0) - (a.confidence || 0);
              case 'conf_asc':
                return (a.confidence || 0) - (b.confidence || 0);
              case 'date_desc':
                return new Date(b.date_added || 0) - new Date(a.date_added || 0);
              case 'date_asc':
                return new Date(a.date_added || 0) - new Date(b.date_added || 0);
              default:
                return 0;
            }
          });

          return result;
        }

        function render() {
          const filtered = getFilteredAndSortedPlants();
          renderGrid(filtered);
        }

        // Attach Event Listeners
        searchInput.addEventListener('input', render);
        sortSelect.addEventListener('change', render);
        confFilter.addEventListener('change', render);
        attrCheckboxes.forEach(cb => cb.addEventListener('change', render));

        // Initial Render
        render();

        function renderGrid(filteredPlants) {
          plantGrid.innerHTML = "";
          if (filteredPlants.length === 0) {
            plantGrid.innerHTML = '<p class="text-center text-gray-500 w-full col-span-full py-8">No plants found matching these filters.</p>';
            return;
          }

          const fragment = document.createDocumentFragment();

          filteredPlants.forEach(plant => {
            // ... (Card creation logic same as before)
            card.className = "bg-white rounded-2xl shadow-md hover:shadow-xl transition p-4 flex flex-col";

            // Circular thumbnail
            const img = document.createElement('img');
            const thumbPath = plant.reference_image.url.replace("photos/", "thumbnails/");
            img.src = thumbPath;
            img.alt = `Photo of ${plant.identified_name}`;
            img.className = "rounded-full w-full h-48 object-cover mb-4";
            img.loading = "lazy";
            card.appendChild(img);

            // Plant name container
            const titleContainer = document.createElement('div');
            titleContainer.className = "flex items-center justify-between";

            // Primary identification
            const title = document.createElement('h2');
            title.textContent = plant.identified_name;
            title.className = "font-bold text-xl text-green-800 mb-1";
            titleContainer.appendChild(title);

            // AI info icon
            const infoIcon = document.createElement('span');
            infoIcon.textContent = "‚ÑπÔ∏è";
            infoIcon.title = "Identified by AI, may contain inaccuracies";
            infoIcon.className = "cursor-help ml-2 text-green-600";
            titleContainer.appendChild(infoIcon);

            // Confidence badge for primary
            // Confidence badge for primary
            if (plant.confidence !== undefined) {
              const confBadge = document.createElement('span');
              const confPercent = Math.round(plant.confidence * 100);
              confBadge.textContent = `Confidence: ${confPercent}%`;

              // New color scale
              let bgColor = confPercent >= 95 ? "green" : confPercent >= 90 ? "yellow" : "red";

              confBadge.className = `text-white text-xs px-2 py-1 rounded-full bg-${bgColor}-500 ml-2`;
              confBadge.title = "AI confidence in this identification";
              titleContainer.appendChild(confBadge);
            }


            card.appendChild(titleContainer);

            // Candidate guesses
            if (plant.candidate_identifications && plant.candidate_identifications.length > 1) {
              const otherGuesses = plant.candidate_identifications.slice(1);
              const guessList = document.createElement('ul');
              guessList.className = "text-sm text-green-700 italic mb-2";
              otherGuesses.forEach(g => {
                const li = document.createElement('li');
                const gPercent = Math.round(g.confidence * 100);
                li.textContent = `${g.identified_name} (${gPercent}%)`;
                guessList.appendChild(li);
              });
              card.appendChild(guessList);
            }

            // Scientific name
            const sci = document.createElement('p');
            sci.textContent = `(${plant.scientific_name})`;
            sci.className = "text-green-600 italic text-sm mb-2";
            card.appendChild(sci);

            // Local names
            if (plant.local_names && plant.local_names.length) {
              const local = document.createElement('p');
              local.textContent = 'Local: ' + plant.local_names.map(l => l.name).join(', ');
              local.className = "text-green-700 text-sm mb-2";
              card.appendChild(local);
            }

            // Attribute badges
            const attrContainer = document.createElement('div');
            attrContainer.className = "flex flex-wrap gap-2 mb-2";
            const attrs = [
              { label: "Flowering", value: plant.is_flowering, color: "green" },
              { label: "Medicinal", value: plant.is_medicinal, color: "blue" },
              { label: "Edible", value: plant.is_edible, color: "yellow" },
              { label: "Toxic", value: plant.is_toxic_to_pets, color: "red" }
            ];
            attrs.forEach(a => {
              if (a.value !== null) {
                const span = document.createElement('span');
                span.textContent = `${a.label}: ${a.value}`;
                span.className = `text-white text-xs px-2 py-1 rounded-full bg-${a.color}-500`;
                attrContainer.appendChild(span);
              }
            });
            card.appendChild(attrContainer);

            // Fun fact
            if (plant.fun_fact && plant.fun_fact.text) {
              const fact = document.createElement('p');
              fact.textContent = `üå± ${plant.fun_fact.text}`;
              fact.className = "text-green-800 italic text-sm mt-auto";
              card.appendChild(fact);
            }

            fragment.appendChild(card);
          });

          plantGrid.appendChild(fragment);
        }


      } catch (e) {
        console.error('Failed to load data/index.json:', e);
      }
    }

    loadPlants();
  </script>

</body>

</html>